# 基于GIS的分布式图书馆管理系统

## 系统概述

本系统是一个基于GIS（地理信息系统）的分布式图书馆管理系统，连接成都市主要高校图书馆，实现跨校图书资源共享和统一管理。

### 核心特性

- **分布式架构**：支持至少3个数据节点，数据分片对用户完全透明
- **查询分解优化**：自动将查询分解并优化，支持水平、垂直和混合数据划分
- **GIS集成**：基于地理位置的图书馆可视化和空间查询
- **实时监控**：所有命令和处理过程实时显示在界面上
- **跨校共享**：支持学生在任何联网图书馆借还图书

## 系统架构

### 分布式节点配置

- **主控制节点**：查询分解、优化和结果合并
- **Node 1 - 四川大学图书馆**：文学、历史、哲学类图书
- **Node 2 - 电子科技大学图书馆**：计算机、电子工程类图书  
- **Node 3 - 西南交通大学图书馆**：交通运输、土木工程类图书

### 数据分片策略

- **水平分片**：按library_id分割数据行
- **垂直分片**：不同表存储在不同节点
- **混合分片**：结合水平和垂直分片策略

## 快速开始

### 环境要求

- Python 3.8+
- Flask 2.3+
- SQLite3
- 现代浏览器（支持JavaScript和WebGL）

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd Nosql
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **启动系统**
```bash
python app.py
```

4. **访问系统**
打开浏览器访问：http://localhost:5000

### 初始化数据

系统启动时会自动初始化：
- 创建数据库表结构
- 初始化3个分布式节点
- 加载示例图书数据
- 配置地理信息数据

## 功能模块

### 1. 分布式查询
- **位置**：导航栏 → SQL查询
- **功能**：执行跨节点SQL查询，查看优化过程
- **示例查询**：
  ```sql
  SELECT * FROM books WHERE category = '计算机科学';
  SELECT name, address FROM libraries;
  SELECT library_id, COUNT(*) FROM books GROUP BY library_id;
  ```

### 2. 查询优化器
- **位置**：导航栏 → 查询优化
- **功能**：查看查询分解、优化步骤和执行计划
- **特性**：投影优化、选择下推、连接优化

### 3. 节点监控
- **位置**：导航栏 → 节点监控
- **功能**：实时监控各节点状态和命令执行
- **内容**：命令日志、网络拓扑、性能指标

### 4. GIS地理信息
- **位置**：导航栏 → 地理信息
- **功能**：
  - 图书馆地理位置可视化
  - 最近图书馆查询
  - 半径范围搜索
  - 路径规划
  - 热力图分析

### 5. 图书管理
- **位置**：导航栏 → 图书管理
- **功能**：
  - 跨校图书搜索
  - 添加新图书
  - 借阅管理
  - 统计分析

### 6. 系统监控
- **位置**：导航栏 → 系统监控
- **功能**：
  - 性能统计
  - 事务日志
  - 系统健康状态
  - 实时图表

## API接口

### 查询接口
```
POST /query
参数: sql (查询语句)
返回: 查询结果和优化信息
```

### 图书管理接口
```
POST /api/books/search
参数: search_term, search_type
返回: 匹配的图书列表

POST /api/books/add
参数: 图书信息
返回: 添加结果

POST /api/books/borrow
参数: user_id, book_id, library_id
返回: 借阅结果
```

### GIS接口
```
POST /api/gis/spatial_query
参数: type, params
返回: 空间查询结果
```

### 监控接口
```
GET /api/statistics
返回: 系统统计信息

GET /api/node/{node_id}/status
返回: 节点状态信息

GET /api/node/{node_id}/commands
返回: 节点命令日志
```

## 测试系统

### 自动化测试
访问 `/testing` 页面执行全面的系统测试：

1. **数据库连接测试**：验证所有节点连接
2. **示例查询测试**：执行预定义查询集
3. **查询优化测试**：测试优化功能
4. **节点通信测试**：验证节点间通信
5. **GIS功能测试**：测试地理信息功能
6. **图书管理测试**：测试图书操作
7. **性能压力测试**：并发查询测试

### 手动测试步骤

1. **基本功能测试**
   - 访问主页，确认系统启动正常
   - 执行简单SQL查询
   - 查看节点监控信息

2. **分布式查询测试**
   - 执行跨节点查询
   - 查看查询分解过程
   - 验证结果合并正确性

3. **GIS功能测试**
   - 查看地图显示
   - 执行空间查询
   - 测试路径规划

4. **图书管理测试**
   - 搜索图书
   - 添加新图书
   - 模拟借还书操作

## 系统配置

### 数据库配置
修改 `config.py` 中的数据库节点配置：
```python
DATABASE_NODES = {
    'node1': {
        'name': '图书馆名称',
        'location': {'lat': 纬度, 'lng': 经度},
        'database': '数据库文件路径'
    }
}
```

### 分片策略配置
```python
SHARDING_CONFIG = {
    'strategy': 'horizontal',  # horizontal, vertical, mixed
    'partition_key': 'library_id',
    'vertical_tables': {
        'node1': ['books', 'authors'],
        'node2': ['users', 'borrowings'],
        'node3': ['libraries', 'locations']
    }
}
```

### GIS配置
```python
GIS_CONFIG = {
    'center_lat': 30.6586,  # 地图中心纬度
    'center_lng': 104.0647,  # 地图中心经度
    'zoom_level': 11,        # 缩放级别
}
```

## 技术实现

### 查询处理流程
1. **查询接收**：主控制节点接收SQL查询
2. **查询分析**：分析查询类型和涉及的表
3. **查询优化**：执行投影、选择、连接优化
4. **查询分解**：根据分片策略分解查询
5. **并发执行**：各节点并发执行查询片段
6. **结果合并**：合并各节点返回的结果
7. **返回结果**：将最终结果返回给用户

### 分布式事务处理
- 使用两阶段提交协议确保数据一致性
- 支持分布式锁机制
- 自动故障检测和恢复

### 地理信息处理
- 使用Folium库生成交互式地图
- 支持多种地图样式和图层
- 集成空间查询算法

## 故障排除

### 常见问题

1. **节点连接失败**
   - 检查数据库文件路径
   - 确认端口没有被占用
   - 查看错误日志

2. **查询执行缓慢**
   - 优化查询语句
   - 检查网络连接
   - 调整系统配置

3. **地图无法显示**
   - 检查浏览器JavaScript支持
   - 确认网络连接正常
   - 清除浏览器缓存

### 日志查看
系统日志信息可在以下位置查看：
- 控制台输出
- 节点监控页面
- 系统监控面板

## 扩展开发

### 添加新节点
1. 在 `config.py` 中添加节点配置
2. 修改数据分片策略
3. 更新前端显示

### 自定义查询优化
1. 扩展 `QueryOptimizer` 类
2. 添加新的优化规则
3. 更新成本估算模型

### 集成新的GIS功能
1. 扩展 `GISManager` 类
2. 添加新的空间查询类型
3. 更新地图显示逻辑

## 许可证

本项目仅供学习和研究使用。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 项目Issues
- 技术文档
- 系统帮助页面



