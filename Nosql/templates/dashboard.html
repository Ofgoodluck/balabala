{% extends "base.html" %}

{% block title %}系统监控 - 分布式图书馆系统{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 系统概览 -->
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-tachometer-alt"></i> 系统监控面板</h2>
            <p class="text-muted">实时监控分布式系统状态和性能指标</p>
            {% if data.error_message %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> {{ data.error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 核心指标卡片 -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h4><i class="fas fa-server"></i></h4>
                    <h2>{{ data.node_status|length if data.node_status else 0 }}</h2>
                    <p>活跃节点</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h4><i class="fas fa-search"></i></h4>
                    <h2>{{ data.performance_stats.get('total_queries', 0) }}</h2>
                    <p>总查询数</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h4><i class="fas fa-clock"></i></h4>
                    <h2>{{ "%.2f"|format((data.performance_stats.get('average_response_time', 0) * 1000)) }}ms</h2>
                    <p>平均响应时间</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h4><i class="fas fa-percentage"></i></h4>
                    <h2>
                        {% if data.performance_stats.get('total_queries', 0) > 0 %}
                            {{ "%.1f"|format((data.performance_stats.get('successful_queries', 0) / data.performance_stats.get('total_queries', 1)) * 100) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </h2>
                    <p>成功率</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 节点状态监控 -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-server"></i> 节点状态监控</h5>
                    <div class="float-end">
                        <span class="badge bg-success">实时监控</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for node_id, node_info in (data.node_status.items() if data.node_status else []) %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-primary node-card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-database"></i> {{ node_info.name }}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>节点ID:</strong> {{ node_id }}
                                    </div>
                                    <div class="mb-2">
                                        <strong>位置:</strong> 
                                        <small>{{ "%.4f"|format(node_info.location.lat) }}, {{ "%.4f"|format(node_info.location.lng) }}</small>
                                    </div>
                                    <div class="mb-2">
                                        <strong>命令数:</strong> 
                                        <span class="badge bg-info">{{ node_info.commands_count }}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>最后活动:</strong>
                                        {% if node_info.last_activity %}
                                            <small class="text-success">{{ node_info.last_activity }}</small>
                                        {% else %}
                                            <small class="text-muted">无记录</small>
                                        {% endif %}
                                    </div>
                                    <div class="text-center">
                                        <a href="/nodes#{{ node_id }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> 查看详情
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 系统信息 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> 系统信息</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>启动时间:</strong><br>
                        <small>
                            {% if data.system_status.get('startup_time') %}
                                {{ data.system_status.get('startup_time') }}
                            {% else %}
                                未知
                            {% endif %}
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <strong>总请求数:</strong><br>
                        <span class="badge bg-primary">{{ data.system_status.get('total_requests', 0) }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>活跃连接:</strong><br>
                        <span class="badge bg-success">{{ data.system_status.get('active_connections', 0) }}</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong>运行时间:</strong><br>
                        <small id="uptime">计算中...</small>
                    </div>
                </div>
            </div>
            
            <!-- GIS统计 -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-map"></i> GIS统计</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>图书馆数量:</strong> {{ data.gis_coverage.get('total_libraries', 0) if data.gis_coverage else 0 }}
                    </div>
                    <div class="mb-2">
                        <strong>网络连接:</strong> {{ data.gis_coverage.get('network_connections', 0) if data.gis_coverage else 0 }}
                    </div>
                    <div class="mb-2">
                        <strong>平均距离:</strong> {{ data.gis_coverage.get('average_distance', 0) if data.gis_coverage else 0 }}km
                    </div>
                    <div class="mb-2">
                        <strong>服务重叠:</strong> {{ (data.gis_coverage.get('service_overlap', [])|length) if data.gis_coverage else 0 }} 处
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 最近事务日志 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> 最近事务日志</h5>
                    <div class="float-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshTransactions()">
                            <i class="fas fa-sync"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>事务ID</th>
                                    <th>类型</th>
                                    <th>详情</th>
                                    <th>状态</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                {% for transaction in (data.recent_transactions if data.recent_transactions else []) %}
                                <tr>
                                    <td>
                                        <small>{{ transaction.timestamp }}</small>
                                    </td>
                                    <td>
                                        <code>{{ transaction.transaction_id }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ transaction.type }}</span>
                                    </td>
                                    <td>
                                        {% if transaction.get('details', {}).get('sql') %}
                                            <code>{{ transaction.details.sql[:50] }}{% if transaction.details.sql|length > 50 %}...{% endif %}</code>
                                        {% elif transaction.get('details', {}).get('error') %}
                                            <span class="text-danger">{{ transaction.details.error[:50] }}{% if transaction.details.error|length > 50 %}...{% endif %}</span>
                                        {% else %}
                                            {{ transaction.get('details', '无详情') or transaction.get('type', 'SELECT') }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if 'ERROR' in transaction.type %}
                                            <span class="status-badge status-error">错误</span>
                                        {% else %}
                                            <span class="status-badge status-success">成功</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能图表区域 -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> 查询性能趋势</h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> 节点负载分布</h5>
                </div>
                <div class="card-body">
                    <canvas id="loadChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.node-card {
    transition: all 0.3s ease;
}

.node-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.metric-card {
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: scale(1.05);
}

#performanceChart, #loadChart {
    max-height: 300px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // 计算并显示运行时间
    updateUptime();
    setInterval(updateUptime, 1000);
    
    // 初始化图表
    initPerformanceChart();
    initLoadChart();
    
    // 定期刷新数据
    setInterval(refreshDashboard, 30000);
});

function updateUptime() {
    const startTime = new Date('{{ data.system_status.get("startup_time").isoformat() if data.system_status.get("startup_time") else "1970-01-01T00:00:00" }}');
    const now = new Date();
    const uptime = now - startTime;
    
    const days = Math.floor(uptime / (1000 * 60 * 60 * 24));
    const hours = Math.floor((uptime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((uptime % (1000 * 60)) / 1000);
    
    $('#uptime').text(`${days}天 ${hours}小时 ${minutes}分 ${seconds}秒`);
}

function refreshTransactions() {
    $.ajax({
        url: '/api/transactions/recent',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            updateTransactionsTable(data);
            showAlert('事务日志已刷新', 'success');
        },
        error: function(xhr, status, error) {
            showAlert('刷新失败: ' + error, 'danger');
        }
    });
}

function updateTransactionsTable(transactions) {
    const tbody = $('#transactionsTable');
    tbody.empty();
    
    transactions.forEach(transaction => {
        const statusClass = transaction.type.includes('ERROR') ? 'status-error' : 'status-success';
        const statusText = transaction.type.includes('ERROR') ? '错误' : '成功';
        
        let details = '';
        if (transaction.details.sql) {
            const sql = transaction.details.sql;
            details = `<code>${sql.substring(0, 50)}${sql.length > 50 ? '...' : ''}</code>`;
        } else if (transaction.details.error) {
            const error = transaction.details.error;
            details = `<span class="text-danger">${error.substring(0, 50)}${error.length > 50 ? '...' : ''}</span>`;
        } else {
            details = JSON.stringify(transaction.details);
        }
        
        const row = `
            <tr>
                <td><small>${transaction.timestamp}</small></td>
                <td><code>${transaction.transaction_id}</code></td>
                <td><span class="badge bg-secondary">${transaction.type}</span></td>
                <td>${details}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            </tr>
        `;
        
        tbody.append(row);
    });
}

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // 模拟性能数据
    const performanceData = {
        labels: ['5分钟前', '4分钟前', '3分钟前', '2分钟前', '1分钟前', '现在'],
        datasets: [{
            label: '响应时间 (ms)',
            data: [120, 110, 95, 105, 88, 92],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    };
    
    new Chart(ctx, {
        type: 'line',
        data: performanceData,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '查询响应时间趋势'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '响应时间 (ms)'
                    }
                }
            }
        }
    });
}

function initLoadChart() {
    const ctx = document.getElementById('loadChart').getContext('2d');
    
    const loadData = {
        labels: ['四川大学', '电子科技大学', '西南交通大学'],
        datasets: [{
            label: '查询负载',
            data: [{{ data.node_status.get('node1', {}).get('commands_count', 0) if data.node_status else 0 }}, 
                   {{ data.node_status.get('node2', {}).get('commands_count', 0) if data.node_status else 0 }}, 
                   {{ data.node_status.get('node3', {}).get('commands_count', 0) if data.node_status else 0 }}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 205, 86, 0.2)'
            ],
            borderColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)'
            ],
            borderWidth: 1
        }]
    };
    
    new Chart(ctx, {
        type: 'doughnut',
        data: loadData,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '各节点查询负载分布'
                }
            }
        }
    });
}

function refreshDashboard() {
    // 刷新整个页面的数据
    location.reload();
}
</script>
{% endblock %}

