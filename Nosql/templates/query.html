{% extends "base.html" %}

{% block title %}SQL查询 - 分布式图书馆系统{% endblock %}
{% block nav_query %}active{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-search"></i> 分布式SQL查询</h2>
            <p class="text-muted">在此执行跨节点查询，系统将自动进行查询分解和优化</p>
        </div>
    </div>
    
    <div class="row">
        <!-- 查询输入区域 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-code"></i> SQL查询编辑器</h5>
                </div>
                <div class="card-body">
                    <form id="queryForm">
                        <div class="mb-3">
                            <label for="sqlQuery" class="form-label">SQL语句</label>
                            <textarea class="form-control" id="sqlQuery" name="sql" rows="8" 
                                      placeholder="请输入SQL查询语句，例如：SELECT * FROM books WHERE category = '计算机科学'"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play"></i> 执行查询
                                </button>
                                <button type="button" class="btn btn-secondary" id="clearQuery">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-lightbulb"></i> 示例查询
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item sample-query" href="#" 
                                           data-query="SELECT * FROM books WHERE category = '计算机科学'">查询计算机类图书</a></li>
                                    <li><a class="dropdown-item sample-query" href="#" 
                                           data-query="SELECT name, address FROM libraries">查询图书馆信息</a></li>
                                    <li><a class="dropdown-item sample-query" href="#" 
                                           data-query="SELECT COUNT(*) as total_books FROM books">统计图书总数</a></li>
                                    <li><a class="dropdown-item sample-query" href="#" 
                                           data-query="SELECT * FROM books WHERE available_copies > 0">查询可借图书</a></li>
                                    <li><a class="dropdown-item sample-query" href="#" 
                                           data-query="SELECT library_id, COUNT(*) as book_count FROM books GROUP BY library_id">各馆图书统计</a></li>
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 查询结果区域 -->
            <div class="card mt-4" id="resultsCard" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> 查询结果</h5>
                    <span id="resultStats" class="badge bg-info float-end"></span>
                </div>
                <div class="card-body">
                    <div id="queryResults" class="query-result"></div>
                </div>
            </div>
            
            <!-- 查询执行信息 -->
            <div class="card mt-4" id="executionCard" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> 执行信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>执行时间:</strong> <span id="executionTime"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>涉及节点:</strong> <span id="nodesInvolved"></span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>优化后SQL:</strong>
                        <pre id="optimizedSQL" class="bg-light p-2 mt-2"></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 查询历史和统计 -->
        <div class="col-md-4">
            <!-- 查询历史 -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> 查询历史</h5>
                </div>
                <div class="card-body">
                    <div id="queryHistory">
                        <p class="text-muted">暂无查询历史</p>
                    </div>
                </div>
            </div>
            
            <!-- 查询提示 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb"></i> 查询提示</h5>
                </div>
                <div class="card-body">
                    <h6>支持的SQL语句:</h6>
                    <ul class="small">
                        <li>SELECT 查询</li>
                        <li>简单的WHERE条件</li>
                        <li>GROUP BY和COUNT</li>
                        <li>ORDER BY排序</li>
                    </ul>
                    
                    <h6 class="mt-3">主要数据表:</h6>
                    <ul class="small">
                        <li><code>books</code> - 图书信息</li>
                        <li><code>libraries</code> - 图书馆信息</li>
                        <li><code>users</code> - 用户信息</li>
                        <li><code>borrowings</code> - 借阅记录</li>
                    </ul>
                    
                    <h6 class="mt-3">查询优化:</h6>
                    <ul class="small">
                        <li>系统会自动分解查询</li>
                        <li>支持跨节点数据合并</li>
                        <li>优化投影和选择操作</li>
                        <li>显示详细执行计划</li>
                    </ul>
                </div>
            </div>
            
            <!-- 实时统计 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> 实时统计</h5>
                </div>
                <div class="card-body">
                    <div id="realtimeStats">
                        <div class="d-flex justify-content-between">
                            <span>总查询数:</span>
                            <span id="totalQueries">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>成功率:</span>
                            <span id="successRate">0%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>平均响应时间:</span>
                            <span id="avgResponseTime">0ms</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 加载遮罩 -->
<div id="loadingOverlay" style="display: none;">
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">查询执行中...</span>
        </div>
        <p class="mt-2">正在执行分布式查询...</p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 9999;
    }
    
    #loadingOverlay .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
    }
    
    .query-result table {
        font-size: 12px;
    }
    
    .sample-query {
        cursor: pointer;
    }
    
    .history-item {
        border-left: 3px solid #3498db;
        padding-left: 10px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 0 5px 5px 0;
    }
    
    .history-item.success {
        border-left-color: #27ae60;
    }
    
    .history-item.error {
        border-left-color: #e74c3c;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let queryHistory = JSON.parse(localStorage.getItem('queryHistory') || '[]');
    
    // 加载查询历史
    loadQueryHistory();
    
    // 加载实时统计
    loadRealtimeStats();
    
    // 表单提交处理
    $('#queryForm').on('submit', function(e) {
        e.preventDefault();
        executeQuery();
    });
    
    // 清空按钮
    $('#clearQuery').on('click', function() {
        $('#sqlQuery').val('');
    });
    
    // 示例查询点击
    $('.sample-query').on('click', function(e) {
        e.preventDefault();
        const query = $(this).data('query');
        $('#sqlQuery').val(query);
    });
    
    function executeQuery() {
        const sql = $('#sqlQuery').val().trim();
        
        if (!sql) {
            showAlert('请输入SQL查询语句', 'warning');
            return;
        }
        
        // 显示加载状态
        $('#loadingOverlay').show();
        
        // 提交查询
        $.ajax({
            url: '/query',
            method: 'POST',
            data: { sql: sql },
            dataType: 'json',
            success: function(response) {
                $('#loadingOverlay').hide();
                handleQueryResponse(response, sql);
            },
            error: function(xhr, status, error) {
                $('#loadingOverlay').hide();
                showAlert('查询请求失败: ' + error, 'danger');
            }
        });
    }
    
    function handleQueryResponse(response, sql) {
        if (response.success) {
            // 显示查询结果
            displayQueryResults(response.results);
            
            // 显示执行信息
            displayExecutionInfo(response);
            
            // 添加到历史记录
            addToHistory(sql, response, true);
            
            showAlert('查询执行成功', 'success');
        } else {
            showAlert('查询执行失败: ' + response.error, 'danger');
            addToHistory(sql, response, false);
        }
        
        // 更新统计信息
        loadRealtimeStats();
    }
    
    function displayQueryResults(results) {
        const $resultsCard = $('#resultsCard');
        const $queryResults = $('#queryResults');
        
        if (results.length === 0) {
            $queryResults.html('<p class="text-muted">查询无结果</p>');
            $('#resultStats').text('0 条记录');
        } else {
            // 生成表格
            const table = generateResultTable(results);
            $queryResults.html(table);
            $('#resultStats').text(`${results.length} 条记录`);
        }
        
        $resultsCard.show();
    }
    
    function generateResultTable(results) {
        if (results.length === 0) return '<p class="text-muted">无数据</p>';
        
        const columns = Object.keys(results[0]);
        
        let html = '<div class="table-responsive"><table class="table table-striped table-sm">';
        
        // 表头
        html += '<thead class="table-dark"><tr>';
        columns.forEach(col => {
            html += `<th>${col}</th>`;
        });
        html += '</tr></thead>';
        
        // 表体
        html += '<tbody>';
        results.forEach(row => {
            html += '<tr>';
            columns.forEach(col => {
                const value = row[col] !== null ? row[col] : '<em class="text-muted">NULL</em>';
                html += `<td>${value}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        
        return html;
    }
    
    function displayExecutionInfo(response) {
        $('#executionTime').text(formatExecutionTime(response.execution_time));
        
        // 显示参与查询的节点信息
        if (response.nodes_queried && response.nodes_queried.length > 0) {
            $('#nodesInvolved').text(response.nodes_queried.join(', '));
        } else if (response.nodes_involved) {
            $('#nodesInvolved').text(response.nodes_involved);
        } else {
            $('#nodesInvolved').text('未知');
        }
        
        if (response.query_info && response.query_info.optimized_sql) {
            $('#optimizedSQL').text(response.query_info.optimized_sql);
        }
        
        $('#executionCard').show();
    }
    
    function addToHistory(sql, response, success) {
        const historyItem = {
            sql: sql,
            timestamp: new Date().toISOString(),
            success: success,
            execution_time: response.execution_time || 0
        };
        
        queryHistory.unshift(historyItem);
        
        // 只保留最近20条
        if (queryHistory.length > 20) {
            queryHistory = queryHistory.slice(0, 20);
        }
        
        localStorage.setItem('queryHistory', JSON.stringify(queryHistory));
        loadQueryHistory();
    }
    
    function loadQueryHistory() {
        const $historyContainer = $('#queryHistory');
        
        if (queryHistory.length === 0) {
            $historyContainer.html('<p class="text-muted">暂无查询历史</p>');
            return;
        }
        
        let html = '';
        queryHistory.slice(0, 10).forEach(item => {
            const statusClass = item.success ? 'success' : 'error';
            const statusIcon = item.success ? 'fa-check' : 'fa-times';
            
            html += `
                <div class="history-item ${statusClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <code class="small">${item.sql.substring(0, 50)}${item.sql.length > 50 ? '...' : ''}</code>
                        <i class="fas ${statusIcon}"></i>
                    </div>
                    <div class="small text-muted mt-1">
                        ${formatTimestamp(item.timestamp)} | ${formatExecutionTime(item.execution_time)}
                    </div>
                </div>
            `;
        });
        
        $historyContainer.html(html);
    }
    
    function loadRealtimeStats() {
        $.ajax({
            url: '/api/statistics',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                if (data.performance) {
                    $('#totalQueries').text(data.performance.total_queries);
                    
                    const successRate = data.performance.total_queries > 0 
                        ? ((data.performance.successful_queries / data.performance.total_queries) * 100).toFixed(1)
                        : 0;
                    $('#successRate').text(successRate + '%');
                    
                    $('#avgResponseTime').text(formatExecutionTime(data.performance.average_response_time));
                }
            },
            error: function(xhr, status, error) {
                console.error('Failed to load statistics:', error);
            }
        });
    }
    
    // 每30秒更新一次统计
    setInterval(loadRealtimeStats, 30000);
});
</script>
{% endblock %}

